<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<section class="form">
    <div><span>是否生成默认</span><input type="checkbox" name="defaultValue" checked="checked" /></div>
    <div>
        <span>性别</span>
        <input type="radio" name="sex" value="boy" checked="checked">男
        <input type="radio" name="sex" value="girl">女
    </div>
    <button class="formSubmit">提交</button>
</section>
<!--<img src="./images/boy.png" alt="">-->
<canvas class="love"></canvas>
<button class="downImgBtn">下载图片</button>

<script>
    const gender = {
        "boy": "./images/boy.png",
        "girl": "./images/girl.png",
    }
    const $canvas = document.querySelector(".love")
    const ctx = $canvas.getContext("2d")
    const img = new Image()
    function generateImg(sex, formValue, formInfo) {
        img.src = sex
        img.onload = function () {
            setCanvasDrawImg()
            appendDateText()
            appendContentText(formValue, formInfo)
            // downLoad($canvas.toDataURL("image/png"))
        }
    }

    function setCanvasDrawImg() {
        $canvas.width = img.width
        $canvas.height = img.height
        ctx.width = img.width
        ctx.height = img.height
        ctx.drawImage(img, 0, 0, img.width, img.height)
    }

    function appendDateText() {
        ctx.font = "30px MicrosoftYaHei"
        const date = getCurDate()
        const x = ctx.width - 58 - ctx.measureText(date).width
        ctx.fillStyle = "#666"
        ctx.fillText(date, x, 58)
    }

    function appendContentText(formValue, formInfo) {
        let origin = {
            x: 116,
            y: 328
        }
        Object.keys(formInfo).forEach((key, index) => {
            ctx.font = "40px MicrosoftYaHei"
            const label = formInfo[key].label
            const value = formValue[key].value
            const text = `${label}：${value}`
            ctx.fillStyle = "#666"
            const result = breakLinesForCanvas(text, 853,'40px MicrosoftYaHei');
            result.forEach((item, i) => {
                ctx.fillText(item, origin.x, origin.y + index * 60)
                if(result.length > 1 && i !== result.length - 1) {
                    console.log(origin.y)
                    origin.y = origin.y + 60
                }
            })
            // console.log(result)
        })
    }

    function getCurDate() {
        const year = new Date().getFullYear()
        const month = new Date().getMonth() + 1
        const date = new Date().getDate()
        return `${year}.${month}.${date}`
    }

    //寻找切换断点
    function findBreakPoint(text, width, context) {
        var min = 0;
        var max = text.length - 1;

        while (min <= max) {
            var middle = Math.floor((min + max) / 2);
            var middleWidth = context.measureText(text.substr(0, middle)).width;
            var oneCharWiderThanMiddleWidth = context.measureText(text.substr(0, middle + 1)).width;
            if (middleWidth <= width && oneCharWiderThanMiddleWidth > width) {
                return middle;
            }
            if (middleWidth < width) {
                min = middle + 1;
            }else {
                max = middle - 1;
            }
        }

        return -1;
    }

    function breakLinesForCanvas(text, width, font) {
        var context = ctx
        var result = [];
        var breakPoint = 0;

        if (font) {
            context.font = font;
        }

        while ((breakPoint = findBreakPoint(text, width, context)) !== -1) {
            result.push(text.substr(0, breakPoint));
            text = text.substr(breakPoint);
        }

        if (text) {
            result.push(text);
        }

        return result;
    }



    // 下载图片的功能
    const downImgBtn = document.querySelector(".downImgBtn")
    downImgBtn.addEventListener("click", function () {
        downLoad($canvas.toDataURL("image/png"))
    })

    function downLoad(url){
        const oA = document.createElement("a");
        oA.download = "boy";// 设置下载的文件名，默认是'下载'
        oA.href = url;
        document.body.appendChild(oA);
        oA.click();
        oA.remove(); // 下载之后把创建的元素删除
    }
</script>

<script>
    const formInfo = {
        birthday: {type: "text", label: "出生年月", value: "2021-01-01"},
        address: {type: "text", label: "户籍地", value: "湖北省武汉市"},
        home: {type: "text", label: "所在地", value: "阳逻经济开发区"},
        school: {type: "text", label: "学历",  value: "本科"},
        height: {type: "text", label: "身高(cm)",  value: "179"},
        weight: {type: "text", label: "体重(Kg)",  value: "77.5"},
        marriage: {type: "text", label: "婚姻状态",  value: "未婚"},
        house: {type: "text", label: "住房情况",  value: "有房有贷"},
        car: {type: "text", label: "是否有车",  value: "有车"},
        work: {type: "text", label: "工作",  value: "电力生产"},
        income: {type: "text", label: "年收入",  value: "15W"},
        evaluation: {type: "textarea", label: "自我评价",  value: "射手座男生，典型的乐观主义者，说话做事比较直接，喜欢美食，旅游，游泳和篮球"},
        requirements: {type: "textarea", label: "择偶要求", value: "有稳定工作，性格好三观正，热爱祖国 热爱生活，长相甜美可爱，好了，合适就是最重要的"},
    }

    const $form = document.querySelector(".form")
    const $formSubmit = document.querySelector(".formSubmit")
    const $isDefaultValue = document.getElementsByName("defaultValue")[0].checked
    // 创建表单
    const keys = Object.keys(formInfo)
    keys.forEach(key => {
        const curVal = formInfo[key]

        const $div = document.createElement("div")
        const $span = document.createElement("span")
        $span.innerText = curVal.label
        $div.appendChild($span)
        if (curVal.type === "text") {
            const $input = document.createElement("input")
            $input.type = "text"
            $input.name = key
            if($isDefaultValue) $input.value = curVal.value
            $div.appendChild($input)
        }
        if(curVal.type === "textarea") {
            const $textarea = document.createElement("textarea")
            $textarea.name = key
            if($isDefaultValue) $textarea.value = curVal.value
            $div.appendChild($textarea)
        }
        $form.appendChild($div)
    })

    const formValue = {}
    $formSubmit.addEventListener("click", function () {

        keys.forEach(key => {
            const val = document.getElementsByName(key)[0]
            formValue[key] = {
                label: formInfo[key].label,
                value: val.value
            }
        })
        const sex = [...document.getElementsByName("sex")].find(item => item.checked).value
        generateImg(gender[sex], formValue, formInfo)
        console.log(sex, formValue)
    })

</script>
</body>
</html>
